<!doctype html><html lang="ar" dir="rtl"><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no"><title>منصة التداول</title><style>*{margin:0;padding:0;box-sizing:border-box}html,body{height:100%;width:100%;overflow:hidden;overscroll-behavior:none}body{font-family:system-ui,-apple-system,"Segoe UI",Tahoma,Arial,sans-serif;background:#000;color:#fff;direction:rtl}button,input{font:inherit;border:0;outline:0}button{cursor:pointer}:root{--psw:48.4px;--psbg:rgba(0,0,0,0);--psshadow:none;--plshadow:none;--bnH:37.4px;--ovAlpha:.35;--safeT:0px;--safeB:0px;--edge:0px;--uiScale:1;--noShadow:0;--psShow:1;--bnSafe:calc(var(--bnH) + var(--safeB));--chartPadL:0px!important;--chartPadR:0px!important}:root[data-psmode="0"]{--psbg:rgba(0,0,0,var(--ovAlpha));--psshadow:inset 1px 0 0 rgba(255,255,255,.10),0 0 18px rgba(0,0,0,.35);--plshadow:0 1px 3px rgba(0,0,0,.6)}:root[data-noshadow="1"]{--psshadow:none!important;--plshadow:none!important}.ui{position:fixed;inset:0;display:flex;flex-direction:column;width:100%;height:100%;padding:0!important;overflow:hidden;transform:scale(var(--uiScale));transform-origin:center}body,.ui{overflow-x:hidden}img,canvas,svg,button,input,div{max-width:100%}.chartWrap{flex:1 1 auto;position:relative;overflow:hidden;background:#000;margin:0!important;padding:0!important}.chartFrame{position:absolute;inset:0;transform:none!important;margin:0!important;padding:0!important;left:0!important;right:0!important}.tc{position:absolute;inset:0;overflow:hidden;background:transparent;margin:0!important;padding:0!important;left:0!important;right:0!important}#c{position:absolute;inset:0;width:100%!important;height:100%!important;padding:0!important;margin:0!important;left:0!important;right:0!important;touch-action:pan-x;cursor:grab}#c:active{cursor:grabbing}.ps{position:absolute;right:0;top:0;bottom:0;width:var(--psw);pointer-events:none;background:var(--psbg)!important;box-shadow:var(--psshadow)!important;z-index:10;display:calc(var(--psShow)*1)?block:block}.pl{position:absolute;right:2.2px;transform:translateY(-50%);font-size:9.9px;font-weight:900;color:rgba(240,230,210,.92);text-align:right;padding:0 3.3px;text-shadow:var(--plshadow)!important}.cpl{position:absolute;right:0;height:1.1px;width:100%;background:rgba(255,255,255,.85);opacity:.85;z-index:15}.cpt{position:absolute;right:2.2px;transform:translateY(-50%);background:#fff;color:#000;padding:2.2px 6.6px;border-radius:3.3px;font-size:9.9px;font-weight:900;z-index:16}.cpl,.cpt{display:calc(var(--psShow)*1)?block:block}.top-bar{flex:0 0 auto;display:flex;justify-content:space-between;align-items:center;padding:6.6px 8.8px;background:#000;height:50.6px}.balance{display:flex;align-items:center;gap:5.5px;background:#0d1117;border:1.1px solid #1f2937;border-radius:8.8px;padding:6.6px 11px;margin:0}.flag-icon{width:19.8px;height:13.2px;border-radius:2.2px}.balance-amount{font-size:14.3px;font-weight:900}.arrow-down{width:13.2px;height:13.2px;margin-right:3.3px}.top-icons{display:flex;gap:6.6px;margin-left:0}.icon-box{width:36.3px;height:36.3px;display:flex;align-items:center;justify-content:center;border-radius:8.8px;overflow:hidden}.icon-box.bright-green{background:#00ff41;border:1.1px solid #00cc33}.icon-box.dark{background:#0d1117;border:1.1px solid #1f2937}.icon-box img{width:100%;height:100%;object-fit:cover}
/* تعديل: الوقت بقى أبيض + على حافة الشمال (يسار الشاشة) */
.datetime{position:absolute;left:8.8px;right:auto;top:62px;transform:none;font-size:11.55px;color:#fff;background:rgba(0,0,0,.72);padding:3.3px 7.7px;border-radius:6.6px;z-index:20;border:1.1px solid rgba(255,255,255,.14)}
.pair-box{position:absolute;left:8.8px;bottom:11px;z-index:20;display:inline-flex;align-items:center;gap:6.6px;background:#0d1117;border:1.1px solid #1f2937;border-radius:11px;padding:5.5px 9.9px;cursor:pointer}.flag-icon-small{width:19.8px;height:13.2px;border-radius:2.2px}.otc{margin-left:6.6px;padding:2.2px 6.6px;border-radius:999px;background:rgba(255,255,255,.10);border:1.1px solid rgba(255,255,255,.18);font-size:11px;font-weight:1000;letter-spacing:.44px}.settings-icon{position:absolute;right:8.8px;bottom:9.9px;width:28.6px;height:28.6px;display:flex;align-items:center;justify-content:center;background:#0d1117;border:1.1px solid #1f2937;border-radius:50%;cursor:pointer;z-index:20}.settings-icon svg{width:16.5px;height:16.5px;stroke:#fff;stroke-width:2.2}.toggle-ctrl{position:absolute;left:50%;transform:translateX(-50%);bottom:8.8px;background:#3b82f6;color:#fff;padding:5.5px 11px;border-radius:11px;font-size:11px;z-index:25;font-weight:900}.toggle-ctrl:active{background:#2563eb}#skeleton{position:absolute;inset:0;z-index:100;background:#000;display:flex;align-items:center;justify-content:center}#skeleton:before{content:"";position:absolute;inset:0;background:linear-gradient(110deg,rgba(16,16,16,.45)0%,rgba(28,28,28,.75)15%,rgba(10,10,10,.85)30%,rgba(28,28,28,.75)45%,rgba(16,16,16,.45)60%,rgba(10,10,10,.85)75%,rgba(16,16,16,.45)100%);background-size:300% 100%;animation:skWave 2.5s cubic-bezier(.4,0,.2,1) infinite}@keyframes skWave{0%{background-position:300% 0}100%{background-position:-300% 0}}.skfade{opacity:0;transition:opacity .16s}.zoomInd{position:absolute;top:11px;left:11px;background:rgba(0,0,0,.85);color:#ffd700;padding:8.8px 15.4px;border-radius:8.8px;font-size:13.2px;font-weight:900;z-index:20;pointer-events:none;opacity:0;transition:opacity .2s;border:1.1px solid rgba(255,215,0,.4)}.zoomInd.show{opacity:1}.candleTimer{position:absolute;background:rgba(0,0,0,.85);color:#ffd700;padding:4.4px 8.8px;border-radius:6.6px;font-size:14.3px;font-weight:900;z-index:25;pointer-events:none;border:1.1px solid rgba(255,215,0,.4);display:none}.zoomLockPanel{position:fixed;left:50%;top:11px;transform:translateX(-50%);z-index:2500;background:rgba(10,22,40,.85);backdrop-filter:blur(8.8px);border:1.1px solid rgba(255,255,255,.15);border-radius:13.2px;padding:8.8px 13.2px;display:flex;align-items:center;gap:11px;box-shadow:0 8.8px 26.4px rgba(0,0,0,.4)}.zoomLockPanel .info{font-size:12.1px;font-weight:900;color:#d9e6ff}.zoomLockPanel .val{color:#00ff88;font-weight:1000}.zoomLockPanel button{padding:5.5px 13.2px;border-radius:8.8px;background:#00ff41;color:#000;font-size:12.1px;font-weight:1000;border:1.1px solid #00cc33}.zoomLockPanel button:active{background:#00cc33}.ctrlPanel{position:fixed;right:8.8px;top:68.2px;z-index:1800;width:min(396px,calc(100vw - 17.6px));background:rgba(10,22,40,.72);backdrop-filter:blur(8.8px);border:1.1px solid rgba(255,255,255,.10);border-radius:15.4px;padding:11px;pointer-events:auto;box-shadow:0 13.2px 33px rgba(0,0,0,.35)}.ctrlTitle{display:flex;align-items:center;justify-content:space-between;gap:11px;margin-bottom:8.8px}.ctrlTitle b{font-size:13.2px;font-weight:1000}.pills{display:flex;gap:6.6px;flex-wrap:wrap}.pill{padding:6.6px 9.9px;border-radius:999px;background:rgba(255,255,255,.05);border:1.1px solid rgba(255,255,255,.10);color:#d9e6ff;font-weight:1000;font-size:12.1px}.pill.primary{background:rgba(24,209,123,.14);border-color:rgba(24,209,123,.55);color:#00e676}.pill.nob{border:none!important;box-shadow:none!important}.gridBtns{display:grid;grid-template-columns:1fr 1fr;gap:6.6px}.gbtn{display:flex;align-items:center;justify-content:space-between;gap:8.8px;padding:8.8px 9.9px;border-radius:13.2px;background:rgba(255,255,255,.035);border:1.1px solid rgba(255,255,255,.09);color:#d9e6ff;font-weight:1000;font-size:12.1px}.gbtn small{opacity:.7;font-weight:900}.card{background:rgba(8,14,26,.92);border:1.1px solid rgba(255,255,255,.10);border-radius:13.2px;padding:8.8px;backdrop-filter:blur(6.6px);margin-bottom:6.6px}.row{display:flex;align-items:center;justify-content:space-between;gap:8.8px}.lbl{color:rgba(255,255,255,.6);font-size:11.55px}.val{color:#d9e6ff;font-weight:1000;font-size:13.2px}.ctrl{display:flex;align-items:center;gap:6.6px;background:rgba(0,0,0,.35);border:1.1px solid rgba(255,255,255,.12);border-radius:13.2px;padding:7.7px}.ctrl button{width:30.8px;height:30.8px;border-radius:999px;background:rgba(255,255,255,.10);border:1.1px solid rgba(255,255,255,.14);color:#fff;font-size:19.8px;display:grid;place-items:center}.ctrl input{width:100%;background:rgba(10,22,40,.95);border:1.1px solid rgba(255,255,255,.12);border-radius:11px;color:#d9e6ff;font-weight:1000;text-align:center;font-size:13.2px;padding:6.6px 8.8px;min-width:0}.time-bar{flex:0 0 auto;display:flex;justify-content:space-between;align-items:flex-end;padding:4.4px 8.8px 2.2px;background:#000;border-top:1.1px solid #111;border-bottom:1.1px solid #111}.time-item{font-size:11px;color:#8b97a6;font-weight:900;line-height:1}.trading-controls{flex:0 0 auto;padding:6.6px 8.8px 0}.control-row{display:grid;grid-template-columns:1fr 1fr;gap:8.8px;margin:0}.input-wrapper{display:flex;align-items:center;gap:4.4px;background:#0d1117;border:1.1px solid #1f2937;border-radius:8.8px;padding:3.3px 6.6px;height:37.4px}.input-field{background:0 0;border:none;color:#fff;font-size:13.75px;font-weight:900;text-align:center;flex:1;min-width:0}.ctrl-btn{background:0 0;color:#60a5fa;font-size:17.6px;cursor:pointer;padding:2.2px 5.5px;font-weight:1000;flex-shrink:0}.ctrl-btn:active{opacity:.6}.tradeDock{flex:0 0 auto;background:#000;padding:6.6px 0 calc(var(--bnSafe) + 6.6px)}.trading-buttons{display:flex;gap:0;padding:0 0}.trade-btn{flex:1;display:flex;align-items:center;justify-content:center;gap:6.6px;padding:11px 8.8px;border:none;border-radius:0;font-size:15.4px;font-weight:1000;cursor:pointer;transition:transform .15s;height:48.4px}.trade-higher{background:linear-gradient(135deg,#00ff41 0%,#00cc33 100%);color:#000;border-radius:0 11px 11px 0}.trade-lower{background:linear-gradient(135deg,#ff0000 0%,#cc0000 100%);color:#fff;border-radius:11px 0 0 11px}.trade-higher:active,.trade-lower:active{transform:scale(.95)}.btn-icon{width:17.6px;height:17.6px;flex-shrink:0}.bottom-nav{position:fixed;bottom:0;left:0;width:100%;height:var(--bnSafe);display:flex;justify-content:space-around;align-items:center;background:#000;border-top:1.1px solid rgba(255,255,255,.16);padding-bottom:0;z-index:2000;box-sizing:border-box}.nav-item{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2.2px;cursor:pointer;padding:0 8.8px;flex:1;height:100%}.nav-icon{width:24.2px;height:24.2px;object-fit:contain;filter:contrast(1.25) brightness(1.2) drop-shadow(0 6.6px 13.2px rgba(0,0,0,.35))}.nav-label{font-size:10.45px;color:#d7e7f2;font-weight:900;line-height:1}.nav-item.active .nav-label{color:#fff}.nav-item.active .nav-icon{filter:contrast(1.35) brightness(1.28) drop-shadow(0 0 7.7px rgba(255,255,255,.25))}.ov{position:fixed;inset:0;z-index:3000;display:none;background:rgba(0,0,0,.45);backdrop-filter:blur(2.2px)}.ov.on{display:block}.ovBox{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:min(572px,calc(100vw - 26.4px));max-height:min(616px,calc(100vh - 132px));background:#101a2f;border:1.1px solid rgba(255,255,255,.10);border-radius:17.6px;box-shadow:0 19.8px 55px rgba(0,0,0,.45);overflow:hidden}.ovHead{display:flex;align-items:center;justify-content:space-between;padding:13.2px 15.4px;border-bottom:1.1px solid rgba(255,255,255,.08);background:linear-gradient(#0d1630,#0b1220)}.ovHead b{font-size:14.3px;font-weight:1000}.ovClose{width:37.4px;height:37.4px;border-radius:13.2px;background:rgba(255,255,255,.06);border:1.1px solid rgba(255,255,255,.10);color:#d9e6ff;font-weight:1000}.ovList{max-height:calc(616px - 105.6px);overflow:auto;padding:6.6px}.it{width:100%;display:flex;align-items:center;justify-content:space-between;gap:11px;padding:11px 13.2px;border-radius:13.2px;background:rgba(255,255,255,.03);border:1.1px solid rgba(255,255,255,.06);color:#d9e6ff;margin:6.6px 0}.it:hover{background:rgba(255,255,255,.05)}.l{display:flex;align-items:center;gap:11px;min-width:0}.star{width:19.8px;height:19.8px;border-radius:6.6px;background:rgba(255,159,42,.10);border:1.1px solid rgba(255,159,42,.30);display:grid;place-items:center;color:#ffb357;font-size:13.2px;flex:0 0 auto}.fg{display:flex;align-items:center}.fg img{width:24.2px;height:24.2px;border-radius:999px;border:2.2px solid #101a2f;margin-left:-8.8px;background:#101a2f}.nm{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-weight:1000}.bad{margin-inline-start:6.6px;padding:2.2px 6.6px;border-radius:999px;background:rgba(255,255,255,.08);border:1.1px solid rgba(255,255,255,.14);font-size:11px;font-weight:1000}@media(max-width:920px){.ctrlPanel{top:auto;bottom:121px}}@media(max-width:420px){:root{--bnH:35.2px}.top-bar{height:48.4px}.trade-btn{height:46.2px;font-size:14.85px}.input-wrapper{height:35.2px}}</style><body><div class="ui"><div class="top-bar"><div class="balance"><img src="https://flagcdn.com/w40/us.png" class="flag-icon"><span class="balance-amount" id="balTxt">$0.00</span><svg class="arrow-down" viewBox="0 0 24 24" fill="#888"><path d="M7 10l5 5 5-5z"></path></svg></div><div class="top-icons"><div class="icon-box bright-green"><img src="https://cdn-icons-png.flaticon.com/128/11937/11937688.png"></div><div class="icon-box dark"><img src="https://cdn-icons-png.flaticon.com/128/149/149071.png"></div></div></div><div class="datetime" id="datetime"></div><div class="zoomLockPanel" id="zoomLockPanel" style="display:none"><div class="info">التكبير: <span class="val" id="lockZoomVal">1.00x</span></div><button id="lockZoomBtn">حفظ الحد</button></div><div class="chartWrap"><div class="chartFrame"><div class="tc"><div class="pair-box" id="pairHud"><span id="pairHudTxt">EUR/USD</span><span class="flags" id="pairFlags"></span><span class="otc">OTC</span><span style="opacity:.7">▾</span></div><div id="skeleton"></div><canvas id="c"></canvas><div class="candleTimer" id="candleTimer">59</div><div class="zoomInd" id="zoomInd">—</div><div class="ps" id="ps"></div><div class="cpl" id="cpl"></div><div class="cpt" id="cpt"></div></div></div><div class="settings-icon" id="dots"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="4" cy="12" r="1"></circle><circle cx="12" cy="12" r="1"></circle><circle cx="20" cy="12" r="1"></circle></svg></div><button class="toggle-ctrl" id="toggleCtrlMini">عرض التحكم</button></div><div class="ctrlPanel" id="ctrlPanel"><div class="ctrlTitle"><b>مقاسات الشارت</b><div class="pills"><button class="pill" id="toggleCtrl">إخفاء</button><button class="pill primary" id="saveLocal">حفظ عام</button><button class="pill" id="noshadowBtn">بدون ظل</button><button class="pill" id="nooverlayBtn">شفافية 0%</button><button class="pill" id="hidePricesBtn">إخفاء الأسعار</button></div></div><div class="card"><div class="row"><div class="lbl">شريط الأسعار</div><div class="val"><span id="pswVal">48</span>px</div></div><div class="ctrl"><button id="pswMinus">-</button><input id="pswInp" inputmode="numeric" value="48"><button id="pswPlus">+</button></div><div class="row" style="margin-top:6.6px"><div class="lbl">وضع الشفافية</div><div class="val"><button class="pill nob" id="psToggle">Overlay</button></div></div></div><div class="card"><div class="row"><div class="lbl">البادينج الجانبي</div><div class="val"><span id="padVal">0</span>px (معطل)</div></div></div><div class="gridBtns"><button class="gbtn" id="panL">تحريك <small>◀</small></button><button class="gbtn" id="panR">تحريك <small>▶</small></button><button class="gbtn" id="viewOut">بيانات أكتر <small>−</small></button><button class="gbtn" id="viewIn">بيانات أقل <small>+</small></button><button class="gbtn" id="wDec">عرض شموع <small>−</small></button><button class="gbtn" id="wInc">عرض شموع <small>+</small></button><button class="gbtn" id="spaceDec">تباعد <small>−</small></button><button class="gbtn" id="spaceInc">تباعد <small>+</small></button><button class="gbtn" id="yDec">طول شموع <small>−</small></button><button class="gbtn" id="yInc">طول شموع <small>+</small></button><button class="gbtn" id="compDec">ضغط سعري <small>−</small></button><button class="gbtn" id="compInc">ضغط سعري <small>+</small></button><button class="gbtn" id="deepZoomOut">تكبير عام <small>−</small></button><button class="gbtn" id="deepZoomIn">تكبير عام <small>+</small></button><button class="gbtn" id="gridDec">حجم Grid <small>−</small></button><button class="gbtn" id="gridInc">حجم Grid <small>+</small></button></div></div><div class="time-bar"><span class="time-item">20:36</span><span class="time-item">21:08</span><span class="time-item">21:40</span><span class="time-item">22:12</span><span class="time-item">22:44</span><span class="time-item">23:16</span><span class="time-item">23:48</span></div><div class="trading-controls"><div class="control-row"><div class="input-wrapper"><button class="ctrl-btn" id="minus">-</button><input class="input-field" value="$ 1" id="amountInput"><button class="ctrl-btn" id="plus">+</button></div><div class="input-wrapper"><input class="input-field" value="00:01:00" id="timeInput"></div></div></div><div class="tradeDock"><div class="trading-buttons"><button class="trade-btn trade-higher" id="buy"><svg class="btn-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M7 14l5-5 5 5z"></path></svg><span>شراء</span></button><button class="trade-btn trade-lower" id="sell"><svg class="btn-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M7 10l5 5 5-5z"></path></svg><span>بيع</span></button></div></div><div class="bottom-nav">
<div class="nav-item active" data-nav="chart"><img class="nav-icon" src="https://cdn-icons-png.flaticon.com/128/893/893214.png"><span class="nav-label">الشارت</span></div>
<div class="nav-item" data-nav="order"><img class="nav-icon" src="https://cdn-icons-png.flaticon.com/128/8490/8490818.png"><span class="nav-label">ترتيب</span></div>
<!-- تعديل: أسفل الإشعارات مباشر أيقونة جديدة + تحتها أيقونة جديدة -->
<div class="nav-item" data-nav="notif"><img class="nav-icon" src="https://cdn-icons-png.flaticon.com/128/9783/9783934.png"><span class="nav-label">اشعارات</span>
<img class="nav-icon" style="margin-top:4.4px;opacity:.95" src="https://cdn-icons-png.flaticon.com/128/18010/18010135.png">
<img class="nav-icon" style="margin-top:2.2px;opacity:.9" src="https://cdn-icons-png.flaticon.com/128/9195/9195918.png">
</div>
<div class="nav-item" data-nav="settings"><img class="nav-icon" src="https://cdn-icons-png.flaticon.com/128/14026/14026955.png"><span class="nav-label">اعدادات</span></div>
</div><div class="ov" id="pairOv"><div class="ovBox"><div class="ovHead"><b>العملات</b><button class="ovClose" id="ovClose">×</button></div><div class="ovList" id="ovList"></div></div></div><script type="module">import{initializeApp as iA}from"https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";import{getAuth as gA,onAuthStateChanged as oASC,signInAnonymously as sIA}from"https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";import{getFirestore as gFS,collection as col,query as q,orderBy as oB,getDocs as gDs,limit as lm,doc as d,setDoc as sD,getDoc as gD,onSnapshot as oS,updateDoc as uD,writeBatch as wB}from"https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";const $=i=>document.getElementById(i);let db=null,auth=null,fbOK=1,currentUser=null;try{const app=iA({apiKey:"AIzaSyA-MK1RYmvpYJrTOBAQcxDqxhp-z_FOb1o",authDomain:"mzjsjjshs.firebaseapp.com",projectId:"mzjsjjshs",storageBucket:"mzjsjjshs.firebasestorage.app",messagingSenderId:"944370558426",appId:"1:944370558426:web:70d4ee772c487f48b58ce3"});db=gFS(app);auth=gA(app)}catch(e){fbOK=0;console.error(e)}const getBal=()=>parseFloat(localStorage.getItem("balance")||"0"),setBal=v=>{localStorage.setItem("balance",String(v));balTxt.textContent="$"+Number(v).toFixed(2)};const getBalDemo=()=>parseFloat(localStorage.getItem("balanceDemo")||"10000"),setBalDemo=v=>{localStorage.setItem("balanceDemo",String(v));balTxt.textContent="$"+Number(v).toFixed(2)};const updateRealBalance=async newBal=>{if(!fbOK||!currentUser)return;try{await uD(d(db,"users",currentUser.uid),{balance:newBal});localStorage.setItem("balance",String(newBal))}catch(e){console.error(e)}};const psClamp=v=>Math.max(0,Number(v)||48.4);const UI_SCALE_KEY="uiScale",applyUiScale=(s)=>{s=Math.max(.5,Math.min(2,Number(s)||1));document.documentElement.style.setProperty("--uiScale",String(s));localStorage.setItem(UI_SCALE_KEY,String(s));window.chart&&chart.setup&&chart.setup()};applyUiScale(Number(localStorage.getItem(UI_SCALE_KEY)||"1"));const NS_KEY="noShadow",setNoShadow=(v)=>{document.documentElement.dataset.noshadow=v?"1":"0";localStorage.setItem(NS_KEY,v?"1":"0")};setNoShadow(localStorage.getItem(NS_KEY)==="1");const OA_KEY="ovAlpha",setOvAlpha=(a)=>{document.documentElement.style.setProperty("--ovAlpha",String(a));localStorage.setItem(OA_KEY,String(a))};setOvAlpha(localStorage.getItem(OA_KEY)||".35");const PS_SHOW_KEY="psShow",setPsShow=v=>{document.documentElement.style.setProperty("--psShow",v?1:0);localStorage.setItem(PS_SHOW_KEY,v?1:0)};setPsShow(localStorage.getItem(PS_SHOW_KEY)!=="0");const setPS=(w,mode)=>{w=psClamp(w);document.documentElement.style.setProperty("--psw",w+"px");localStorage.setItem("psw",String(w));pswVal.textContent=String(Math.round(w));pswInp.value=String(Math.round(w));if(mode==null)mode=+(localStorage.getItem("psm")||"1");mode=mode?1:0;document.documentElement.dataset.psmode=String(mode);localStorage.setItem("psm",String(mode));psToggle.textContent=mode?"Overlay":"Bar";window.chart&&chart.setup&&chart.setup()};const flagMap={AED:"ae",CNY:"cn",AUD:"au",CAD:"ca",CHF:"ch",BHD:"bh",EUR:"eu",RUB:"ru",USD:"us",KES:"ke",LBP:"lb",QAR:"qa",TRY:"tr",SYP:"sy",EGP:"eg",INR:"in"};const mkFlag=c=>`https://flagcdn.com/w40/${flagMap[c]||"un"}.png`;const fmtPct=p=>(Math.round((Number(p)||0)*100)+"%");const defaultPairs=[{pair:"AED/CNY",otc:1,payout:.91,flags:["AED","CNY"]},{pair:"AUD/CAD",otc:1,payout:.88,flags:["AUD","CAD"]},{pair:"AUD/CHF",otc:1,payout:.92,flags:["AUD","CHF"]},{pair:"BHD/CNY",otc:1,payout:.86,flags:["BHD","CNY"]},{pair:"EUR/RUB",otc:1,payout:.77,flags:["EUR","RUB"]},{pair:"EUR/USD",otc:1,payout:.92,flags:["EUR","USD"]},{pair:"KES/USD",otc:1,payout:.84,flags:["KES","USD"]},{pair:"LBP/USD",otc:1,payout:.79,flags:["LBP","USD"]},{pair:"QAR/CNY",otc:1,payout:.83,flags:["QAR","CNY"]},{pair:"USD/CHF",otc:1,payout:.89,flags:["USD","CHF"]},{pair:"SYP/TRY",otc:1,payout:.87,flags:["SYP","TRY"]},{pair:"EGP/USD",otc:1,payout:.78,flags:["EGP","USD"]},{pair:"USD/INR",otc:1,payout:.90,flags:["USD","INR"]}];const state={pairs:new Map(),fav:new Set(JSON.parse(localStorage.getItem("favPairs")||"[]"))};const saveFav=()=>localStorage.setItem("favPairs",JSON.stringify([...state.fav]));const setLocalPairs=()=>{state.pairs.clear();defaultPairs.forEach(x=>state.pairs.set(x.pair,x))};const updatePairFlags=(pair,container)=>{const meta=state.pairs.get(pair)||defaultPairs.find(x=>x.pair===pair);if(!meta)return;const flags=meta.flags||String(pair).split("/");container.innerHTML=flags.map(c=>`<img src="${mkFlag(c)}" class="flag-icon-small">`).join("")};function renderOverlay(){const ov=ovList;if(!ov)return;const arr=[...state.pairs.values()].sort((a,b)=>{const fa=state.fav.has(a.pair)?1:0,fb=state.fav.has(b.pair)?1:0;if(fa!==fb)return fb-fa;return a.pair.localeCompare(b.pair)});ov.innerHTML=arr.map(x=>{const[a,b]=String(x.pair).split("/");const star=state.fav.has(x.pair)?"★":"☆";return`<button class="it" data-p="${x.pair}"><span class="l"><span class="star" data-s="1">${star}</span><span class="fg"><img src="${mkFlag(a)}"><img src="${mkFlag(b)}"></span><span class="nm">${x.pair}<span class="bad">OTC</span></span></span><span class="r">+${fmtPct(x.payout)}</span></button>`}).join("")}const skShow=()=>{let sk=$("skeleton");if(!sk){sk=document.createElement("div");sk.id="skeleton";document.querySelector(".tc").prepend(sk)}sk.classList.remove("skfade")};const skHide=()=>{const sk=$("skeleton");if(!sk)return;sk.classList.add("skfade");setTimeout(()=>sk.remove(),190)};const BASE={volatility:.0008,trend:.00005};const pairData={"EUR/USD":{price:1.0895,seed:33333,digits:5},"USD/TRY":{price:1.0922,seed:33377,digits:5},"SYP/TRY":{price:1.0868,seed:33411,digits:5},"EGP/USD":{price:1.091,seed:33555,digits:5}};const defUI=()=>({gZoom:1,viewZoom:1,spacingMul:1,candleMul:1,priceZoom:1,priceComp:1,pan:0,ctrl:1,gridSize:50,deepZoom:1});const clampUI=u=>({gZoom:u.gZoom||1,viewZoom:u.viewZoom||1,spacingMul:u.spacingMul||1,candleMul:u.candleMul||1,priceZoom:u.priceZoom||1,priceComp:u.priceComp||1,pan:u.pan||0,ctrl:u.ctrl?1:0,gridSize:u.gridSize||50,deepZoom:u.deepZoom||1});class Chart{constructor(pair){this.cv=c;this.ctx=c.getContext("2d");this.host=c.closest(".tc");this.cs=[];this.cc=null;this.baseSpacing=12;this.baseCandleWidth=8;this.drag=0;this.dragStartX=0;this.dragStartScroll=0;this.manualScrollOffset=0;this.autoScroll=false;this.tf=6e4;this.t0=Math.floor(Date.now()/6e4)*6e4;this.xPadB=0;this.ui=defUI();this.tradeMarkers=[];this.targetGridSize=50;this.isMaster=false;this.liveUnsub=null;this.forcedCandles=new Map();this.deepZoom=1;this.setPair(pair,1);this.setup();this.ev();this.boot()}setPair(pair,init){const pd=pairData[pair]||{price:1,seed:(Math.random()*9e5)|0,digits:5};pairData[pair]=pd;this.pair=pair;this.d={...BASE,...pd};this.key=pair.replace("/","_");this.candlesCol="candles_"+this.key;this.cp=this.d.price;this.priceRange={min:this.d.price*.95,max:this.d.price*1.05};if(!init){pairHudTxt.textContent=pair;updatePairFlags(pair,pairFlags)}}setup(){const dpr=devicePixelRatio||1,rect=this.host.getBoundingClientRect();this.w=Math.max(0,rect.width);this.h=Math.max(0,rect.height);this.cv.width=(this.w*dpr)|0;this.cv.height=(this.h*dpr)|0;this.cv.style.width=this.w+"px";this.cv.style.height=this.h+"px";this.ctx.setTransform(dpr,0,0,dpr,0,0)}applyUI(u){this.ui=clampUI({...this.ui,...u});this.zoomLevel=this.ui.gZoom;this.viewZoom=this.ui.viewZoom;this.spacingMultiplier=this.ui.spacingMul;this.candleWidthMultiplier=this.ui.candleMul;this.priceZoom=this.ui.priceZoom;this.priceCompression=this.ui.priceComp;this.manualScrollOffset=this.ui.pan;this.targetGridSize=this.ui.gridSize||50;this.deepZoom=this.ui.deepZoom;zoomInd.textContent="G:"+this.zoomLevel.toFixed(2)+" D:"+this.deepZoom.toFixed(2);zoomInd.classList.add("show");lockZoomVal.textContent=this.deepZoom.toFixed(2)+"x";clearTimeout(this._zT);this._zT=setTimeout(()=>{zoomInd.classList.remove("show");zoomLockPanel.style.display="none"},1500);zoomLockPanel.style.display="flex"}setCtrl(v){ctrlPanel.style.display=v?"block":"none";toggleCtrl.textContent=v?"إخفاء":"إظهار";this.ui.ctrl=v?1:0}getSpacing(){return this.baseSpacing*this.zoomLevel*this.spacingMultiplier*this.deepZoom}getCandleWidth(){return Math.max(1,this.baseCandleWidth*this.zoomLevel*this.candleWidthMultiplier*this.deepZoom)}getMinScrollOffset(){return 0}snapToLive(){this.autoScroll=false;this.manualScrollOffset=0;this.ui.pan=0}getScrollOffset(){return Math.min(0,this.manualScrollOffset)}indexToX(i){return this.getScrollOffset()+i*this.getSpacing()}xToIndex(x){return(x-this.getScrollOffset())/this.getSpacing()}rnd(s){const x=Math.sin(s)*1e4;return x-Math.floor(x)}gen(t,b){const fk=`${this.key}_${t}`;if(this.forcedCandles.has(fk)){const f=this.forcedCandles.get(fk);return{open:b==null?this.cp:b,close:f.close,high:Math.max(b,f.close),low:Math.min(b,f.close),timestamp:t}}const s=this.d.seed+Math.floor(t/this.tf),r1=this.rnd(s),r2=this.rnd(s+1),r3=this.rnd(s+2),r4=this.rnd(s+3),o=b==null?this.cp:b,v=this.d.volatility*(.8+r1*1.4),tr=this.d.trend*(r2-.5)*2,dir=r3>.5?1:-1,ch=dir*v+tr,c=o+ch,hm=v*(.4*r4),lm=v*(.4*(1-r4)),dg=this.d.digits;return{open:+o.toFixed(dg),close:+c.toFixed(dg),high:+Math.max(o,c,o+hm,c+hm).toFixed(dg),low:+Math.min(o,c,o-lm).toFixed(dg),timestamp:t}}getPriceRange(){const c=(this.priceRange.min+this.priceRange.max)/2,hr=((this.priceRange.max-this.priceRange.min)/2)/(this.priceZoom*this.priceCompression);return{min:c-hr,max:c+hr}}priceToY(p){const r=this.getPriceRange(),n=(p-r.min)/(r.max-r.min);return(this.h-this.xPadB)*(1-n)}updatePriceRange(){let v=[...this.cs];this.cc&&v.push(this.cc);if(!v.length){this.priceRange={min:this.d.price*.95,max:this.d.price*1.05};return}const s=Math.floor(this.xToIndex(0)),e=Math.ceil(this.xToIndex(this.w)),vis=v.slice(Math.max(0,s-5),Math.min(v.length,e+5));if(!vis.length){this.priceRange={min:this.d.price*.95,max:this.d.price*1.05};return}const lows=vis.map(x=>x.low),highs=vis.map(x=>x.high),mn=Math.min(...lows),mx=Math.max(...highs),pad=(mx-mn)*.15||1e-9;this.priceRange={min:mn-pad,max:mx+pad}}niceStep(r){const p=[1,2,5,10],x=Math.pow(10,Math.floor(Math.log10(r||1))),f=r/x;return(p.find(v=>f<=v)||10)*x}updatePriceScale(){ps.innerHTML="";if(localStorage.getItem(PS_SHOW_KEY)==="0")return;const r=this.getPriceRange(),span=r.max-r.min,lines=11,step=this.niceStep(span/lines),start=Math.floor(r.min/step)*step;for(let p=start;p<=r.max+step;p+=step){const y=this.priceToY(p);if(y<-20||y>(this.h-this.xPadB)+20)continue;const lb=document.createElement("div");lb.className="pl";lb.style.top=y+"px";lb.textContent=p.toFixed(this.d.digits);ps.appendChild(lb)}}updateCurrentPriceLine(){if(localStorage.getItem(PS_SHOW_KEY)==="0"){cpl.style.display="none";cpt.style.display="none";return}cpl.style.display="block";cpt.style.display="block";const y=this.priceToY(this.cp);cpl.style.top=y+"px";cpt.style.top=y+"px";cpt.textContent=this.cp.toFixed(this.d.digits)}updateCandleTimer(){const now=Date.now(),el=now-this.t0,left=Math.max(0,Math.ceil((this.tf-el)/1000));candleTimer.textContent=String(left);if(this.cc){const x=this.indexToX(this.cs.length),y=this.priceToY(this.cc.close);if(x>=-60&&x<=this.w+60){candleTimer.style.left=Math.max(10,Math.min(this.w-60,x+25))+"px";candleTimer.style.top=Math.max(10,Math.min(this.h-30,y-15))+"px";candleTimer.style.display="block"}else candleTimer.style.display="none"}else candleTimer.style.display="none"}async loadCandles(){this.cs=[];this.cc=null;this.cp=this.d.price;if(!fbOK)return;try{const qy=q(col(db,this.candlesCol),oB("timestamp","desc"),lm(100)),sn=await gDs(qy);const tmp=[];sn.forEach(d=>tmp.unshift(d.data()));this.cs=tmp;this.cs.length&&(this.cp=this.cs.at(-1).close)}catch(e){console.error(e)}}async initCandleGeneration(){if(!fbOK)return;const now=Date.now();if(!this.cs.length){const startTime=Math.floor(now/this.tf)*this.tf-this.tf*100;let base=this.d.price;const batch=wB(db);for(let i=0;i<100;i++){const t=startTime+i*this.tf;const cd=this.gen(t,base);this.cs.push(cd);batch.set(d(col(db,this.candlesCol)),cd);base=cd.close}await batch.commit();this.cp=base;return}const last=this.cs.at(-1);if(!last)return;const expectedNext=last.timestamp+this.tf,gapMs=now-expectedNext;if(gapMs<this.tf)return;const gapCount=Math.floor(gapMs/this.tf);let base=last.close;const batchSize=Math.min(gapCount,200);const BATCH_LIMIT=500;let batch=wB(db),batchCount=0;for(let i=0;i<batchSize;i++){const t=last.timestamp+(i+1)*this.tf;const cd=this.gen(t,base);this.cs.push(cd);batch.set(d(col(db,this.candlesCol)),cd);batchCount++;if(batchCount>=BATCH_LIMIT){await batch.commit();batch=wB(db);batchCount=0}base=cd.close}batchCount>0&&await batch.commit();this.cp=base;this.cs=this.cs.slice(-1000)}async becomeMaster(){if(!fbOK||this.isMaster)return;try{const liveRef=d(db,"liveCandles",this.key);const snap=await gD(liveRef);if(!snap.exists()||!snap.data().masterActive||Date.now()-snap.data().lastUpdate>5000){this.isMaster=true;await sD(liveRef,{pair:this.pair,masterActive:true,lastUpdate:Date.now(),currentCandle:null,t0:this.t0},{merge:true});this.startMasterTick()}}catch(e){console.error(e)}}async startMasterTick(){if(!this.isMaster||!fbOK)return;const liveRef=d(db,"liveCandles",this.key);setInterval(async()=>{if(!this.isMaster)return;try{await uD(liveRef,{currentCandle:this.cc,lastUpdate:Date.now(),t0:this.t0,cp:this.cp})}catch(e){console.error(e)}},500)}subscribeToLiveCandle(){if(!fbOK||this.isMaster)return;const liveRef=d(db,"liveCandles",this.key);this.liveUnsub=oS(liveRef,(snap)=>{if(!snap.exists()||this.isMaster)return;const data=snap.data();if(data.currentCandle){this.cc=data.currentCandle;this.cp=data.cp||this.cc.close;this.t0=data.t0||this.t0}},err=>console.error(err))}updateCurrentCandle(){if(!this.isMaster)return;if(!this.cc){const lp=this.cs.length?this.cs.at(-1).close:this.cp;this.cc=this.gen(this.t0,lp);return}const seed=this.d.seed+Date.now(),r=this.rnd(seed),cr=this.d.volatility*.3,ch=(r-.5)*cr,nc=+(this.cc.close+ch).toFixed(this.d.digits);this.cc.close=nc;this.cc.high=+Math.max(this.cc.high,nc+r*cr*.3).toFixed(this.d.digits);this.cc.low=+Math.min(this.cc.low,nc-(1-r)*cr*.3).toFixed(this.d.digits);this.cp=nc;this.tradeMarkers.forEach(m=>{if(m.settled)return;const cp=nc,op=m.entryPrice;m.currentPrice=cp;m.currentPL=(m.dir==="buy")?(cp>op?m.amount*.9:cp<op?-m.amount:0):(cp<op?m.amount*.9:cp>op?-m.amount:0)})}async tick(){if(!this.on)return;const now=Date.now(),el=now-this.t0;if(el>=this.tf){if(this.isMaster&&this.cc){this.cs.push(this.cc);const batch=wB(db);batch.set(d(col(db,this.candlesCol)),this.cc);await batch.commit();this.cs.length>1e3&&this.cs.shift();this.updatePriceRange()}this.t0=Math.floor(now/6e4)*6e4;if(this.isMaster){const lp=this.cc?this.cc.close:this.cp;this.cc=this.gen(this.t0,lp)}}else this.isMaster&&this.updateCurrentCandle();this.updatePriceRange();this.updatePriceScale();this.updateCurrentPriceLine();this.updateCandleTimer();setTimeout(()=>this.tick(),200)}drawGrid(){const step=Math.max(12,Math.min(260,(this.targetGridSize||50)));this.ctx.strokeStyle="rgba(255,255,255,.14)";this.ctx.lineWidth=1;for(let x=0;x<=this.w;x+=step){this.ctx.beginPath();this.ctx.moveTo(x,0);this.ctx.lineTo(x,this.h);this.ctx.stroke()}for(let y=0;y<=this.h;y+=step){this.ctx.beginPath();this.ctx.moveTo(0,y);this.ctx.lineTo(this.w,y);this.ctx.stroke()}}drawCandle(cd,x,live){const o=this.priceToY(cd.open),cl=this.priceToY(cd.close),hi=this.priceToY(cd.high),lo=this.priceToY(cd.low),bull=cd.close>=cd.open,col=bull?"#00c853":"#d32f2f",w=this.getCandleWidth();this.ctx.strokeStyle=col;this.ctx.lineWidth=Math.max(1,w*.18);this.ctx.beginPath();this.ctx.moveTo(x,hi);this.ctx.lineTo(x,lo);this.ctx.stroke();const bh=Math.max(1,Math.abs(cl-o)),bt=Math.min(o,cl);this.ctx.fillStyle=col;live&&(this.ctx.shadowColor=col,this.ctx.shadowBlur=7);this.ctx.fillRect(x-w/2,bt,w,bh);live&&(this.ctx.shadowBlur=0)}drawTradeMarkers(){this.tradeMarkers=this.tradeMarkers.filter(m=>!m.settled);this.tradeMarkers.forEach(m=>{const y=this.priceToY(m.entryPrice),x=this.indexToX(m.candleIndex);if(x<-100||x>this.w+100)return;const col=m.dir==="buy"?"#2ecc71":"#e74c3c";this.ctx.save();this.ctx.strokeStyle=col;this.ctx.lineWidth=2;this.ctx.setLineDash([5,5]);this.ctx.beginPath();this.ctx.moveTo(Math.max(0,x),y);this.ctx.lineTo(Math.min(this.w,x+300),y);this.ctx.stroke();this.ctx.setLineDash([]);const sz=Math.max(20,24*this.deepZoom);this.ctx.fillStyle=col;this.ctx.shadowColor="rgba(0,0,0,.6)";this.ctx.shadowBlur=8;this.ctx.shadowOffsetY=2;this.ctx.font=`900 ${sz}px Arial`;this.ctx.textAlign="center";this.ctx.textBaseline="middle";this.ctx.fillText(m.dir==="buy"?"▲":"▼",x,y);this.ctx.shadowBlur=0;this.ctx.shadowOffsetY=0;const amtTxt="$"+Number(m.amount).toFixed(0);this.ctx.font=`800 ${Math.max(11,13*this.deepZoom)}px Arial`;this.ctx.fillStyle="#fff";this.ctx.strokeStyle="rgba(0,0,0,.85)";this.ctx.lineWidth=3;this.ctx.strokeText(amtTxt,x,y-sz-8);this.ctx.fillText(amtTxt,x,y-sz-8);this.ctx.restore()})}draw(){this.ctx.clearRect(0,0,this.w,this.h);this.drawGrid();for(let i=0;i<this.cs.length;i++){const x=this.indexToX(i);if(x<-60||x>this.w+60)continue;this.drawCandle(this.cs[i],x,0)}if(this.cc){const x=this.indexToX(this.cs.length);x>=-60&&x<=this.w+60&&this.drawCandle(this.cc,x,1)}this.drawTradeMarkers()}loop(){this.on&&(this.draw(),requestAnimationFrame(()=>this.loop()))}ev(){addEventListener("resize",()=>this.setup());this.cv.addEventListener("wheel",e=>{e.preventDefault();const r=this.cv.getBoundingClientRect(),mx=e.clientX-r.left,f=e.deltaY<0?1.08:1/1.08;this.applyUI({deepZoom:this.deepZoom*f});const i=this.xToIndex(mx),nx=this.indexToX(i);this.manualScrollOffset+=mx-nx;this.ui.pan=this.manualScrollOffset},{passive:false});const down=x=>{this.drag=1;this.dragStartX=x;this.dragStartScroll=this.manualScrollOffset;this.autoScroll=false};const move=x=>{if(this.drag){const delta=x-this.dragStartX;this.manualScrollOffset=this.dragStartScroll+delta;this.ui.pan=this.manualScrollOffset}};const up=()=>this.drag=0;this.cv.addEventListener("mousedown",e=>down(e.clientX));addEventListener("mousemove",e=>move(e.clientX));addEventListener("mouseup",()=>up());const dist=(t1,t2)=>Math.hypot(t2.clientX-t1.clientX,t2.clientY-t1.clientY),midX=(t1,t2)=>(t1.clientX+t2.clientX)/2;this.cv.addEventListener("touchstart",e=>{if(e.touches.length===1){const t=e.touches[0];t&&down(t.clientX)}else if(e.touches.length===2){this.drag=0;this.pinch=1;this.p0=dist(e.touches[0],e.touches[1]);const r=this.cv.getBoundingClientRect();this.pMid=midX(e.touches[0],e.touches[1])-r.left;this.pStartUI={g:this.zoomLevel,v:this.viewZoom,pz:this.priceZoom,pan:this.manualScrollOffset,deep:this.deepZoom}}},{passive:false});this.cv.addEventListener("touchmove",e=>{e.preventDefault();if(this.pinch&&e.touches.length===2&&this.pStartUI){const dd=dist(e.touches[0],e.touches[1]);let ff=Math.max(.2,Math.min(5,dd/(this.p0||dd)));this.applyUI({gZoom:this.pStartUI.g*ff,viewZoom:this.pStartUI.v*ff,priceZoom:this.pStartUI.pz*ff,deepZoom:this.pStartUI.deep*ff,pan:this.manualScrollOffset});const i=this.xToIndex(this.pMid),nx=this.indexToX(i);this.manualScrollOffset+=this.pMid-nx;this.ui.pan=this.manualScrollOffset}else if(!this.pinch&&e.touches.length===1){const t=e.touches[0];t&&move(t.clientX)}},{passive:false});this.cv.addEventListener("touchend",e=>{if(e.touches.length<2){this.pinch=0;this.pStartUI=null;this.p0=0}if(e.touches.length===0)up()},{passive:false});this.cv.addEventListener("touchcancel",()=>{this.pinch=0;this.pStartUI=null;this.p0=0;up()},{passive:false})}async boot(){skShow();try{await this.loadCandles();await this.initCandleGeneration();this.snapToLive();this.updatePriceRange();await this.becomeMaster();if(!this.isMaster)this.subscribeToLiveCandle()}catch(e){console.error(e)}finally{skHide();this.on=1;this.tick();this.loop()}}async switchPair(pair){if(pair===this.pair)return;this.liveUnsub&&(this.liveUnsub(),this.liveUnsub=null);skShow();this.on=0;this.isMaster=false;this.setPair(pair,0);this.t0=Math.floor(Date.now()/6e4)*6e4;await this.boot()}}const chart=new Chart("EUR/USD");window.chart=chart;updatePairFlags("EUR/USD",pairFlags);setPS(localStorage.getItem("psw")||48.4,localStorage.getItem("psm"));pswPlus.onclick=()=>setPS((+localStorage.getItem("psw")||48.4)+2.2);pswMinus.onclick=()=>setPS((+localStorage.getItem("psw")||48.4)-2.2);pswInp.oninput=()=>{pswInp.value=String(pswInp.value||"").replace(/[^\d]/g,"")};pswInp.onblur=()=>setPS(pswInp.value);psToggle.onclick=()=>{const cur=+(localStorage.getItem("psm")||"1"),next=cur?0:1;setOvAlpha(next?".35":"0");setPS(localStorage.getItem("psw")||48.4,next)};nooverlayBtn.onclick=()=>{setOvAlpha("0");nooverlayBtn.textContent="تم";setTimeout(()=>nooverlayBtn.textContent="شفافية 0%",700)};noshadowBtn.onclick=()=>{const v=!(localStorage.getItem(NS_KEY)==="1");setNoShadow(v);noshadowBtn.textContent=v?"ظل: OFF":"بدون ظل";setTimeout(()=>noshadowBtn.textContent="بدون ظل",900)};hidePricesBtn.onclick=()=>{const v=!(localStorage.getItem(PS_SHOW_KEY)!=="0");setPsShow(v);hidePricesBtn.textContent=v?"إخفاء الأسعار":"إظهار الأسعار";setTimeout(()=>hidePricesBtn.textContent=v?"إخفاء الأسعار":"إظهار الأسعار",900);chart.updatePriceScale();chart.updateCurrentPriceLine()};lockZoomBtn.onclick=()=>{lockZoomBtn.textContent="✓";setTimeout(()=>lockZoomBtn.textContent="حفظ الحد",900)};window.__getTradeDurationSec=()=>{const m=String(timeInput.value||"").match(/(\d{2}):(\d{2}):(\d{2})/);return m?(+m[1]*3600+ +m[2]*60+ +m[3]):60};const TRADES_KEY="trades_v2",trades=JSON.parse(localStorage.getItem(TRADES_KEY)||"[]");const saveTrades=()=>localStorage.setItem(TRADES_KEY,JSON.stringify(trades.slice(0,120)));const rndId=()=>{const A="ABCDEFGHJKLMNPQRSTUVWXYZ23456789";let s="";for(let i=0;i<9;i++)s+=A[(Math.random()*A.length)|0];return s};const getPairMeta=p=>state.pairs.get(p)||defaultPairs.find(x=>x.pair===p)||{pair:p,otc:1,payout:.9,flags:String(p).split("/")};const settleTrade=async t=>{const meta=getPairMeta(t.pair),payout=Number(meta.payout||.9),open=+t.openPrice,close=+t.closePrice,win=t.dir==="buy"?close>open:close<open,res=win?+(t.amount*(1+payout)).toFixed(2):0;t.resultAmt=res;const accType=localStorage.getItem("accType")||"demo";if(accType==="real"){const cur=getBal(),nb=cur+res;setBal(nb);await updateRealBalance(nb)}else setBalDemo(getBalDemo()+res)};setInterval(()=>{for(const t of trades)if(t.left>0){t.left=Math.max(0,Math.ceil((t.end-Date.now())/1000));const m=chart.tradeMarkers.find(x=>x.tid===t.tid);m&&m.currentPL!=null&&(t.liveResult=m.currentPL);if(t.left===0&&!t.settled){t.settled=1;t.closePrice=chart.cp;settleTrade(t);saveTrades()}}},250);chart.createTrade=(dir,amount,durationSec)=>{amount=Math.max(1,Number(amount)||1);const accType=localStorage.getItem("accType")||"demo";let bal=accType==="real"?getBal():getBalDemo();if(bal<amount)return;if(accType==="real"){const nb=bal-amount;setBal(nb);updateRealBalance(nb)}else setBalDemo(bal-amount);durationSec=Math.max(1,Number(durationSec)||60);const meta=getPairMeta(chart.pair),payout=Number(meta.payout||.9),payoutAmt=+(amount*(1+payout)).toFixed(2),tid=rndId(),start=Date.now(),end=start+durationSec*1000,openPrice=chart.cp,candleIndex=chart.cs.length;trades.unshift({tid,dir,pair:chart.pair,amount,payout,payoutAmt,start,end,left:durationSec,dur:durationSec,openPrice,closePrice:null,settled:0,resultAmt:null,liveResult:null,candleIndex});saveTrades();chart.tradeMarkers.push({tid,dir,amount,entryPrice:openPrice,candleIndex,settled:0,currentPrice:openPrice,currentPL:0})};const PAN=176,FA=1.12;panL.onclick=()=>{chart.autoScroll=false;chart.applyUI({pan:chart.manualScrollOffset+PAN})};panR.onclick=()=>{chart.autoScroll=false;chart.applyUI({pan:chart.manualScrollOffset-PAN})};viewIn.onclick=()=>chart.applyUI({viewZoom:chart.viewZoom*FA,gZoom:chart.zoomLevel*FA,priceZoom:chart.priceZoom*FA});viewOut.onclick=()=>chart.applyUI({viewZoom:chart.viewZoom/FA,gZoom:chart.zoomLevel/FA,priceZoom:chart.priceZoom/FA});wInc.onclick=()=>chart.applyUI({candleMul:chart.candleWidthMultiplier/chart.viewZoom*FA});wDec.onclick=()=>chart.applyUI({candleMul:chart.candleWidthMultiplier/chart.viewZoom/FA});spaceInc.onclick=()=>chart.applyUI({spacingMul:chart.ui.spacingMul*FA});spaceDec.onclick=()=>chart.applyUI({spacingMul:chart.ui.spacingMul/FA});yInc.onclick=()=>chart.applyUI({priceZoom:chart.priceZoom*FA});yDec.onclick=()=>chart.applyUI({priceZoom:chart.priceZoom/FA});compInc.onclick=()=>chart.applyUI({priceComp:chart.priceCompression*FA});compDec.onclick=()=>chart.applyUI({priceComp:chart.priceCompression/FA});deepZoomIn.onclick=()=>chart.applyUI({deepZoom:chart.deepZoom*FA});deepZoomOut.onclick=()=>chart.applyUI({deepZoom:chart.deepZoom/FA});gridInc.onclick=()=>chart.applyUI({gridSize:chart.targetGridSize*FA});gridDec.onclick=()=>chart.applyUI({gridSize:chart.targetGridSize/FA});toggleCtrl.onclick=()=>{const show=ctrlPanel.style.display!=="none";chart.setCtrl(!show)};toggleCtrlMini.onclick=()=>toggleCtrl.click();saveLocal.onclick=()=>{saveLocal.textContent="تم ✓";setTimeout(()=>saveLocal.textContent="حفظ عام",800)};(()=>{let amt=1;const upd=()=>{let s=String(amountInput.value).replace(/,|\$|\s/g,"").trim();if(!s){amt=1;amountInput.value="$ 1";return}let v=parseFloat(s);if(!isFinite(v))v=1;v=Math.max(1,Math.min(999999,v));amt=v;amountInput.value="$ "+v};plus.onclick=()=>{amt++;amountInput.value="$ "+amt};minus.onclick=()=>{amt=Math.max(1,amt-1);amountInput.value="$ "+amt};amountInput.oninput=upd;amountInput.onblur=upd;upd();buy.onclick=()=>{const a=parseFloat(String(amountInput.value).replace(/,|\$|\s/g,""))||1;chart.createTrade("buy",a,window.__getTradeDurationSec())};sell.onclick=()=>{const a=parseFloat(String(amountInput.value).replace(/,|\$|\s/g,""))||1;chart.createTrade("sell",a,window.__getTradeDurationSec())}})();pairHud.onclick=e=>{e.stopPropagation();pairOv.classList.add("on")};ovClose.onclick=()=>pairOv.classList.remove("on");pairOv.onclick=e=>{e.target===pairOv&&pairOv.classList.remove("on")};addEventListener("keydown",e=>{e.key==="Escape"&&pairOv.classList.remove("on")});ovList.onclick=e=>{const b=e.target.closest("button.it");if(!b)return;const p=b.getAttribute("data-p");if(e.target&&e.target.getAttribute&&e.target.getAttribute("data-s")){state.fav.has(p)?state.fav.delete(p):state.fav.add(p);saveFav();renderOverlay();return}pairOv.classList.remove("on");chart.switchPair(p)};function updateDateTime(){const n=new Date,h=String(n.getHours()).padStart(2,"0"),mi=String(n.getMinutes()).padStart(2,"0"),s=String(n.getSeconds()).padStart(2,"0");datetime.textContent=`${h}:${mi}:${s} (UTC+03:00)`}setInterval(updateDateTime,1e3);updateDateTime();
/* تعديل: ضغط "اشعارات" يعمل Redirect إلى profile.hmtl */
document.querySelectorAll(".nav-item").forEach(it=>it.addEventListener("click",function(){document.querySelectorAll(".nav-item").forEach(i=>i.classList.remove("active"));this.classList.add("active");if(this.dataset&&this.dataset.nav==="notif")location.href="profile.hmtl"}));
if(fbOK&&auth)oASC(auth,async user=>{if(user)currentUser=user;else try{currentUser=(await sIA(auth)).user}catch(e){console.error(e)}});setLocalPairs();renderOverlay();const accType=localStorage.getItem("accType")||"demo";accType==="demo"?setBalDemo(getBalDemo()):setBal(getBal());</script></div></body></html>
